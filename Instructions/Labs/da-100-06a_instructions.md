

### ラボ 06A

Power BI Desktop での DAX の使用、パート 1

# 概要

**ラボを完了するための所要時間は 45 分です**

このラボでは、Data Analysis Expressions (DAX) を使用して、計算テーブル、計算列、および簡易メジャーを作成します。

このラボでは、次の方法を学習します。

* 計算テーブルの作成

* 計算列の作成

* メジャーの作成

# 演習 1: 計算テーブルの作成

この演習では、2 つの計算テーブルを作成します。最初のテーブルは 「**販売担当者**」 テーブルで、このテーブルと 「**営業**」 テーブルとの間の直接のリレーションシップを許可します。2 つ目のテーブルは、「**日付**」 テーブルです。

前のラボが正常に完了したと確信がない場合は、**D:\DA100\Lab05A\Solution** フォルダーにある前のラボのソリューション ファイルを開くことができます。

### タスク 1: 営業担当者テーブルの作成

このタスクでは、**営業担当者**テーブル (**営業** に直接リレーションシップ) を作成します。

1. Power BI Desktop にある 「レポート」 ビューの 「**モデリング**」 リボンで、「**計算**」 グループ内から 「**新しいテーブル**」 をクリックします。     

	![画像 1](Linked_image_Files/PowerBI_Lab06A_image1.png)

2. 数式バー (計算の作成時または編集時にリボンの直下に表示される) に「**営業担当者 =**」と入力し、**Shift キーと Enter キー**を押し、「**営業担当者 (実績)**」と入力し、**Enter キー**を押します。       

	![画像 4](Linked_image_Files/PowerBI_Lab06A_image2.png)

	*便宜上、このラボのすべての DAX 定義は **D:\DA100\Lab06A\Assets\Snippets.txt** ファイルからコピーできます*。

	*計算テーブルを作成するには、まずテーブル名を入力し、次に等号 (=) を入力し、次にテーブルを返す DAX 式を入力します。テーブル名は、データ モデルに存在できません*。

	*数式バーは、有効な DAX 式の入力に対応しています。オートコンプリート、Intellisense、カラーコーディングなどの機能が含まれており、式をすばやく正確に入力できます*。

	*このテーブル定義は、**営業担当者 (パフォーマンス)** テーブルのコピーを作成します。  データのみがコピーされるが、表示設定、書式設定などのプロパティはコピーされません*。

	*ヒント: 数式が長くて複雑な場合は特に、直感的で読みやすい形式で数式をレイアウトするには、「空白」(復帰とタブなど) を入力することをお勧めします。復帰改行を入力するには、**Shift キーを押しながら Enter キー**を押します。"空白" はオプションです*。

3. 「**フィールド**」 ウィンドウで、テーブル アイコンが青色 (計算テーブルを示す) になっていることに注目します。

	![画像 10](Linked_image_Files/PowerBI_Lab06A_image3.png)

	*計算テーブルは、テーブルを返す DAX 式を使用して定義されます。計算テーブルは、値を具体化して格納するため、データ モデルのサイズが大きくなることを理解しておくことが重要です。これらは、新しい (将来の) 日付値がテーブルにロードされるデータ モデルの場合と同様に、数式の依存関係が更新されるたびに再計算されます*。

	*Power Query ソース テーブルとは異なり、計算テーブルを使用して外部データ ソースからデータを読み込むことはできません。これらのファイルは、既にデータ モデルに読み込まれているデータに基づいてのみ変換できます*。

4. モデル ビューに切り替えます。

5. **営業担当者**テーブルが使用可能であることに注意してください (ビューから非表示になっている可能性があります。水平方向にスクロールして検索してください)。

6. **営業担当者**からのリレーションシップの作成 **| EmployeeKey** 列から **Sales | EmployeeKey** 列。

7. **営業担当者 (業績)** テーブルと **Sales** テーブルの間の非アクティブなリレーションシップを右クリックし、「**削除**」 を選択します。

	![画像 2](Linked_image_Files/PowerBI_Lab06A_image4.png)

8. 削除の確認を求められたら、「**削除**」 をクリックします。

	![画像 3](Linked_image_Files/PowerBI_Lab06A_image5.png)

9. 「営業担当者」 テーブルで、次の列を複数選択し、非表示にします。

	* EmployeeID

	* 従業員キー

	* UPN

10. ダイアグラムで、**営業担当者**テーブルを選択します。

11. 「**プロパティ**」 ペインの 「**説明**」 ボックスに、次のように入力します。**販売に関連した営業担当者**

	*ユーザーがテーブルまたはフィールドにカーソルを合わせると、その説明が 「**フィールド**」 ウィンドウにツール チップとして表示されることを思い出してください*。

12. 「**営業担当者 (業績)**」 テーブルの説明を次の値に設定します。**地域に関連する営業担当者**

	*データ モデルは、営業担当者を分析する際に代替手段を提供するようになりました。**営業担当者**テーブルでは、営業担当者による営業売上の分析が可能で、**営業担当者 (業績)** テーブルでは、営業担当者に割り当てられた販売地域での営業を分析できます*。

### タスク 2: 日付テーブルを作成する

このタスクでは、**日付**テーブルを作成します。

1. データ ビューに切り替えます。

	![画像 29](Linked_image_Files/PowerBI_Lab06A_image6.png)

2. 「**ホーム**」 リボン タブの 「**計算**」 グループ内から、「**新しいテーブル**」 をクリックします。

	![画像 5](Linked_image_Files/PowerBI_Lab06A_image7.png)

3. 数式バーに次のように入力します。


	**DAX**

	```
	Date =  
	‎CALENDARAUTO(6)
	```

	![画像 6](Linked_image_Files/PowerBI_Lab06A_image8.png)

	*CALENDARAUTO() 関数は、日付値から構成される単一列のテーブルを返します。"auto" 動作は、すべてのデータ モデル日付列をスキャンして、データ モデルに格納されている最も古い日付と最新の日付値を判別します。次に、この範囲内の日付ごとに 1 行を作成し、範囲をいずれかの方向に拡張して、完全な年のデータが格納されるようにします。*

	*この関数は、1 年の最後の月数である 1 つの省略可能な引数を受け取ることができます。省略した場合、値は 12 で、12 月は年の最後の月になります。この場合は 6 が入力され、6 月が年の最後の月になります*。

4. 日付値の列に注目してください。

	*列が表示されない場合は、「**フィールド**」 ウィンドウで別のテーブルを選択し 、**Date** テーブルを選択します。*

	![画像 7](Linked_image_Files/PowerBI_Lab06A_image9.png)

	*表示される日付は、米国の地域設定 (つまり、mm/dd/yyyy) を使用して書式設定されます*。

5. 左下のステータス バーで、テーブルの統計情報に注目し、5 年間のデータを表す 1826 行のデータが生成されたことを確認します。

	![画像 9](Linked_image_Files/PowerBI_Lab06A_image10.png)

### タスク 3: 計算列の作成

このタスクでは、別の期間によるフィルター処理とグループ化を有効にする列を追加します。また、他の列の並べ替え順序を制御する計算列も作成します。

1. 「**テーブル ツール**」 コンテキスト リボンの 「**計算**」 グループ内から、「**新しい列**」 をクリックします。

	![画像 11](Linked_image_Files/PowerBI_Lab06A_image11.png)

2. 数式バーに次のように入力して、**Enter** キーを押します。


	**DAX**

	```
	Year =

	"FY" & YEAR('Date'[Date]) + IF(MONTH('Date'[Date]) > 6, 1)
	```

	*計算列は、最初に列名を入力し、次に等号 (=) を入力し、続いて単一値の結果を返す DAX 数式を作成します。列名はテーブルに既に存在することはできません*。

	*数式では、日付の年の値を使用しますが、月が 6 月の後の場合は年の値に 1 を加算します。これは、Adventure Works の会計年度を計算する方法です*。

3. 新しい列が追加されたことを確認します。

	![画像 12](Linked_image_Files/PowerBI_Lab06A_image12.png)

4. スニペット ファイルの定義を使用して、**日付**テーブルの次の 2 つの計算された列を作成します。

	* 四半期

	* 月

	![画像 14](Linked_image_Files/PowerBI_Lab06A_image13.png)

5. 計算を検証するには、レポート ビューに切り替えます。

6. 新しいレポート ページを作成するには、左下のプラス アイコンをクリックします。

	![画像 15](Linked_image_Files/PowerBI_Lab06A_image14.png)

7. 新しいレポート ページにマトリックス ビジュアルを追加するには、「**視覚化**」 ウィンドウでマトリックス ビジュアルの種類を選択します。

	*ヒント: 各アイコンの上にカーソルを置くと、ビジュアル タイプを説明するヒントが表示されます*。

	![画像 16](Linked_image_Files/PowerBI_Lab06A_image15.png)

8. 「**フィールド**」 ウィンドウの 「**日付**」 テーブル内から 「**年**」 フィールドを 「**行**」 ウェルにドラッグします。

	![画像 17](Linked_image_Files/PowerBI_Lab06A_image16.png)

9. 「**月**」 フィールドを 「**行**」 ウェルにドラッグし、「**年**」 フィールドのすぐ下に移動します。

	![画像 18](Linked_image_Files/PowerBI_Lab06A_image17.png)

10. マトリックス ビジュアルの右上にある、フォークされた二重矢印アイコンをクリックします  (すべての年を 1 レベル下に展開します) 。

	![画像 19](Linked_image_Files/PowerBI_Lab06A_image18.png)

11. 年が月に拡大し、月が時系列ではなくアルファベット順に並べ替えられていることに注意してください。

	![画像 20](Linked_image_Files/PowerBI_Lab06A_image19.png)

	*既定では、テキスト値はアルファベット順に並べ替えられ、数値は最小から最大に、日付は最も古い日付から最新の日付に並べ替えられます*。

12. 「**月**」 フィールドの並べ替え順序をカスタマイズするには、データ ビューに切り替えます。

13. 「**日付**」 テーブルに 「**MonthKey**」 列を追加します。


	**DAX**

	```
	MonthKey =

	(YEAR('Date'[Date]) * 100) + MONTH('Date'[Date]) + MONTH ( [Date] ))
	```

	*この式は、年/月の組み合わせごとに数値を計算します*。

14. データ ビューで、新しい列に数値が含まれていることを確認します (201707 は 2017 年 7 月など)。

	![画像 21](Linked_image_Files/PowerBI_Lab06A_image20.png)

15. レポート ビューに戻ります。

16. 「**フィールド**」 ウィンドウで、「**月**」 フィールドが選択されていることを確認します (選択すると、背景は濃い灰色になります)。

17. 「**列ツール**」 コンテキスト リボンの 「**並べ替え**」 グループ内から、「**列で並べ替え**」 をクリックし、「**MonthKey**」 を選択します。

	![画像 22](Linked_image_Files/PowerBI_Lab06A_image21.png)

18. マトリックス ビジュアルでは、月が時系列で並べ替えられます。

	![画像 23](Linked_image_Files/PowerBI_Lab06A_image22.png)

### タスク 4: 日付テーブルを完成する

このタスクでは、列を非表示にして階層を作成することにより、**日付**テーブルの設計を完了します。次に、「**売上**」 テーブルと 「**ターゲット**」 テーブルへのリレーションシップを作成します。

1. モデル ビューに切り替えます。

2. **日付**テーブルで、**MonthKey** 列を非表示にします。

3. 「**Date**」 テーブルで、次の 3 つのレベルを持つ **Fiscal** という名前の階層を作成します。  

	* 年

	* 四半期

	* 月

	![画像 24](Linked_image_Files/PowerBI_Lab06A_image23.png)

4. 次の 2 つのモデル関係を作成します。

	* **日付 | 日付** から **販売 | Orderdate**

	* **日付 | 「ターゲット」** までの **「日付」 | TargetMonth**

5. 次の 2 つの列を非表示にします。

	* 売上 | Orderdate

	* ターゲット | TargetMonth

### タスク 5: 日付テーブルをマークする

このタスクでは、「**日付**」 テーブルを日付テーブルとしてマークします。

1. レポートビューに切り替えます。

2. 「**フィールド**」 ウィンドウで、「**日付**」 テーブル (フィールドではなく) を選択します。   

3. 「**テーブル ツール**」 コンテキスト リボンの 「**カレンダー**」  グループ内から、「**日付テーブルとしてマーク**」 をクリックし、「**日付テーブルとしてマーク**」 を選択します。       

	![画像 8](Linked_image_Files/PowerBI_Lab06A_image24.png)

4. 「**日付テーブルとしてマーク**」 ウィンドウの 「**日付列**」 ドロップダウン リストで、「**日付**」 を選択します。     

	![画像 37](Linked_image_Files/PowerBI_Lab06A_image25.png)

5. 「**OK**」 をクリックします。

	![画像 26](Linked_image_Files/PowerBI_Lab06A_image26.png)

6. Power BI Desktop ファイルを保存します。

	*Power BI Desktop は、このテーブルが日付 (時刻) を定義していることを認識するようになりました。これは、タイム インテリジェンスの計算に依存する場合に重要です。**ラボ 06B*** で時間インテリジェンス計算を行います。

	*データ ソースに日付テーブルがない場合は、日付テーブルに対してこの設計方法が適しています。データ ウェアハウスにアクセスできる場合は、データ モデルで日付ロジックを「再定義」するのではなく、日付ディメンション テーブルから日付データを読み込むのが適切です*。

# 演習 2: メジャーの作成

この演習では、いくつかのメジャーを作成していくつかを書式設定します。

### タスク 1: 単純なメジャーを作成する

このタスクでは、単純なメジャーを作成します。単純なメジャーは、単一の列またはテーブルを集計します。

1. レポート ビューの 「**ページ 2**」 の 「**フィールド**」 ウィンドウで 、「**売上**」 をドラッグします **| 単価** フィールドをマトリックス ビジュアルへ。

	![画像 27](Linked_image_Files/PowerBI_Lab06A_image27.png)

***ラボ 05A** では、**単価**列を**平均**で要約するように設定したことを思い出してください。マトリックス ビジュアルに表示される結果は、月平均単価です*。

2. ビジュアル フィールド ウィンドウ (**視覚化** ウィンドウの下) の**値**ウェルに、**単価**が一覧表示されていることに注目してください。

	![画像 28](Linked_image_Files/PowerBI_Lab06A_image28.png)

3. **単価**の下向き矢印をクリックすると、利用可能なメニューオプションが表示されます。

	![画像 30](Linked_image_Files/PowerBI_Lab06A_image29.png)

	*表示可能な数値列を使用すると、レポートの作成者は、レポートのデザイン時に列をどのように要約するか（または要約しないか）を決定できます。これにより、不適切な報告が発生する可能性があります。ただし、一部のデータモデル作成者は、物事を偶然に任せたくないので、これらの列を非表示にし、代わりにメジャーによって定義された集計ロジックを公開することを選択します。これは、このラボで取り上げるアプローチです*。

4. メジャーを作成するには、「**フィールド**」 ウィンドウで 「**売上**」 テーブルを右クリックし、「**新しいメジャー**」 を選択します。

	![画像 31](Linked_image_Files/PowerBI_Lab06A_image30.png)

5. 数式バーで、次のメジャー定義を追加します。


	**DAX**

	```
	Avg Price = AVERAGE(Sales[Unit Price])
	```

6. **平均価格**メジャーをマトリックス ビジュアルに追加します。 

7. **単価**列と同じ結果になります (ただし、書式設定は異なります)。

8. 「**値**」 ウェルで、「**平均価格**」 フィールドのコンテキスト メニューを開き、集計手法を変更できないことに注意してください。

	![画像 32](Linked_image_Files/PowerBI_Lab06A_image31.png)

9. スニペットファイルの定義を使用して、**売上**テーブルに次の 5 つのメジャーを作成します。

	* 中央値価格

	* 最小価格

	* 最大価格

	* 注文

	* 注文明細行

***注文**メジャーで使用される DISTINCTCOUNT () 関数は、注文を 1 回だけカウントします (重複は無視されます)。**注文明細行**メジャーで使用される COUNTROWS() 関数は 、テーブルを介して動作します。  この場合、注文数は個別の**販売注文番号**列の値をカウントして計算されますが 、注文明細行の数は単にテーブルの行数です (各行は注文の行です)*。 

10. モデル ビューに切り替え、次の 4 つの価格メジャーを複数選択します。**平均価格**、**最大価格**、**中央値価格**、**最小価格**。

11. メジャーの複数選択については、次の要件を設定します。

	* 小数点以下 2 桁の書式を設定

	* 「**価格**」 という名前の表示フォルダーに割り当てる

	![画像 33](Linked_image_Files/PowerBI_Lab06A_image32.png)

12. 「**単価**」 列を非表示にします。 

	*この時、レポート作成者は 「**単価**」 列を使用できません。モデルに追加したメジャーを使用する必要があります。この設計アプローチにより、レポート作成者が価格を集計するなど、価格を不適切に集計することがなくなります*。

13. 「**注文**」 メジャーと 「**注文明細行**」 メジャーを複数選択し、次の要件を設定します。   

	* 桁区切り記号を使用する書式を設定する

	* 「**数**」 という名前の表示フォルダーに割り当てる

	![画像 36](Linked_image_Files/PowerBI_Lab06A_image33.png)

14. レポート ビューにある、マトリックス ビジュアルの 「**値**」 ウェルで、「**単価**」 フィールドの 「X」 をクリックして削除します。   

	![画像 38](Linked_image_Files/PowerBI_Lab06A_image34.png)

15. ページの幅と高さを埋めるために、マトリックス ビジュアルのサイズを大きくします。

16. マトリックス ビジュアルに次の 5 つの新しいメジャーを追加します。

	* 中央値価格

	* 最小価格

	* 最大価格

	* 注文

	* 注文明細行

17. 結果が適切に表示され、正しく書式設定されていることを確認します。

	![画像 39](Linked_image_Files/PowerBI_Lab06A_image35.png)

### タスク 2: 追加メジャーの作成

このタスクでは、より複雑な式を使用する追加のメジャーを作成します。

1. レポート ビューで、「**ページ 1**」 を選択します。 

	![画像 40](Linked_image_Files/PowerBI_Lab06A_image36.png)

2. テーブル ビジュアルを確認し、「**目標**」 列の合計に注意します。

	![画像 41](Linked_image_Files/PowerBI_Lab06A_image37.png)

	*営業担当者の目標は、各人の営業地域の割り当てに基づいて各人に設定されるため、目標値を合計しても意味がありません。目標値は、フィルター処理が 1 名の営業担当者に対する場合にのみ表示する必要があります。ここで、それを行うためだけにメジャーを実装します*。

3. テーブル ビジュアルで、「**目標**」 フィールドを削除します。 

	![画像 42](Linked_image_Files/PowerBI_Lab06A_image38.png)

4. 「**目標**」 の名前の変更 | 「**目標**」 としての 「**目標**」 列 **| TargetAmount**。

	*ヒント: レポート ビューで列の名前を変更するには、いくつかの方法があります。**「フィールド」** ウィンドウで列を右クリックし、「**名前の変更**」 を選択するか、列をダブルクリックするか、または 「**F2***」 キーを押します。 

	*「**目標**」 という名前のメジャーを作成しようとしています。同じテーブルに同じ名前を付けて列とメジャーを持つ方法はありません*。

5. 「**目標**」 テーブルで次のメジャーを作成します。 


	**DAX**

	```
	Target =

	IF(

	HASONEVALUE('Salesperson (Performance)'[Salesperson]),

	SUM(Targets[TargetAmount])
	
	)
	```

	*HASONEVALUE() 関数は、「**営業担当者**」  列の単一の値がフィルター処理されているかどうかをテストします。  true の場合、式は対象の金額の合計を返します (その営業担当者に対してのみ)。false の場合は、空白が返されます*。

6. 小数点以下の桁数がゼロの**目標**メジャーを書式設定します。 

	*ヒント: **メジャー ツール** コンテキスト リボンを使用できます*。

7. 「**目標金額**」 列を非表示にします。 

8. 「**目標**」 メジャーをテーブル ビジュアルに追加します。

9. 「**目標**」 列の合計が空白になったことに注意してください。

	![画像 43](Linked_image_Files/PowerBI_Lab06A_image39.png)

10. スニペット ファイル定義を使用して、「**目標**」 テーブルに次の 2 つのメジャーを作成します。

	* 差異

	* 差異マージン

11. 小数点以下の桁数がゼロの場合は、「**差異**」 メジャーを書式設定します。 

12. 「**差異マージン**」 メジャーを小数点以下 2 桁の割合で書式設定します。 

13. テーブル ビジュアルに 「**差異**」 と 「**差異幅**」 メジャーを追加します。   

14. テーブルの表示を拡大し、すべての値が表示されるようにします。

	![画像 44](Linked_image_Files/PowerBI_Lab06A_image40.png)

	*すべての営業担当者が目標を満たしていないように見えますが、メジャーは特定の期間でまだフィルタリングされていません。**ラボ 07A*** でユーザーが選択した期間でフィルター処理する販売実績レポートを作成します。

15. 「**フィールド**」 ウィンドウの右上隅で 、折りたたみ、展開ウィンドウを開きます。 

	![画像 45](Linked_image_Files/PowerBI_Lab06A_image41.png)

	*ウィンドウを折りたたんで再度開くと、コンテンツがリセットされます*。

16. 「**目標**」 テーブルがリストの先頭に表示されることに注意してください。

	![画像 46](Linked_image_Files/PowerBI_Lab06A_image42.png)

	*表示されるメジャーのみを構成するテーブルは、自動的にリストの一番上に表示されます*。

### 仕上げ

このタスクでは、ラボを完了します。

1. Power BI Desktop ファイルを保存します。

2. Power BI Desktop を開いたままにしておきます。

	*次のラボでは、DAX を使用して、より高度な計算を使用してデータ モデルを拡張します*。
